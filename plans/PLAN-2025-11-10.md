# Plan for Converting copyedit.sh to Python

**Date**: 2025-11-10

## Current State Analysis

### Bash Script Features (scripts/copyedit.sh)

- Accepts text from stdin or file argument
- Passes through arguments to llm CLI (model selection, streaming options, etc.)
- Uses a detailed system prompt with specific copyediting instructions
- Outputs corrected text with a summary of changes at the bottom

### Existing Project Structure

- Typer-based CLI framework in `src/copyedit_ai/__main__.py`
- Settings management via Pydantic in `src/copyedit_ai/settings.py`
- Logger configured with loguru
- Currently has only a "self" subcommand for managing the tool

## Implementation Plan

### 1. Add llm dependency to pyproject.toml

Add `llm` to the dependencies list to use the Python API

### 2. Create core copyediting module (`src/copyedit_ai/copyedit.py`)

- Define the system prompt as a constant (extracted from bash script)
- Create a `copyedit()` function that:
  - Takes input text and optional model name
  - Uses `llm.get_model()` to get the model
  - Calls `model.prompt()` with the system prompt
  - Returns the response

### 3. Add main command to CLI (`__main__.py`)

- Create a main command that becomes the default action
- Accept optional file path as argument (or read from stdin if not provided)
- Add options for:
  - `--model/-m`: Specify LLM model to use
  - `--stream/--no-stream`: Control streaming output
  - Additional llm options as needed
- Handle input reading (file vs stdin)
- Call the copyedit function and display results

### 4. Update Settings (`settings.py`)

- Add configuration for default model
- Add any other copyedit-specific settings (e.g., default stream behavior)

### 5. Create tests (`tests/test_copyedit.py`)

- Test reading from stdin
- Test reading from file
- Test model selection
- Mock llm calls to avoid hitting APIs in tests

### 6. Update project scripts entry point

- Consider adding a shorter alias like `copyedit` alongside `copyedit_ai`

## Key Design Decisions

- **Python API over CLI**: Use llm's Python API (`llm.get_model()`) instead of shelling out to the llm CLI for better integration and error handling
- **Typer integration**: Leverage Typer's built-in features for stdin handling and file arguments
- **Backwards compatibility**: Maintain the same UX as the bash script (stdin, file, or pipe input)
- **Extensibility**: Structure code to allow future enhancements (batch processing, format-specific editing, etc.)

## File Changes Required

1. `pyproject.toml` - Add llm dependency
2. `src/copyedit_ai/copyedit.py` - New module with core logic
3. `src/copyedit_ai/__main__.py` - Add main copyedit command
4. `src/copyedit_ai/settings.py` - Add copyedit-specific settings
5. `tests/test_copyedit.py` - New test file
6. `tests/test_cli.py` - Update to test new command

## System Prompt from Bash Script

The bash script uses the following system prompt:

```
You are copyeditor that suggests and makes edits on text.

You review the text you receive for punctuation, grammatical,
spelling, and logical errors. Try hard to keep the style and tone but
make corrections as needed. Summarize any corrections you made at the
bottom of the text in bullet point format.

Don't make any commentary at the beginning of your output. Just output
the corrected code to start off. Use a string of '=' characters to
separate corrected text from your comments.

Always, always, always output the document to start. Even if you don't
make any changes. Do not ignore this instruction.

If the text looks like markdown, ignore fenced quotes or leading text with
> . Don't edit the quoted text.

Do not modify emojis.
```

## User Experience Goals

The Python implementation should maintain the same simple UX:

```bash
# Read from stdin
copyedit_ai < draft.txt

# Read from file
copyedit_ai draft.txt

# Pipe input
cat draft.txt | copyedit_ai -m claude-opus

# Specify model
copyedit_ai --model gpt-4o draft.txt
```

---

## Implementation Complete - Summary

Successfully integrated **click-default-group** with Typer to make the `edit` command the default command. Now you can use the simpler syntax:

### Usage Examples

```bash
# These all work now without explicit "edit" subcommand:
copyedit_ai < draft.txt
copyedit_ai draft.txt
cat draft.txt | copyedit_ai -m claude-opus

# Explicit "edit" command still works:
copyedit_ai edit draft.txt

# Other subcommands work normally:
copyedit_ai self version
```

### Implementation Details

1. **Used `click-default-group`** package (already installed)
2. **Modified `__main__.py`** to:
   - Create a Typer app as usual
   - Convert it to a Click group using `typer.main.get_command()`
   - Replace the Click group's class with `DefaultGroup`
   - Set the default command to `"edit"`

3. **Key code**:
   ```python
   def cli() -> None:
       """CLI entry point with default command support."""
       click_group = typer.main.get_command(app)
       click_group.__class__ = DefaultGroup
       click_group.default_cmd_name = "edit"
       click_group.default_if_no_args = True
       click_group()
   ```

4. **Help output shows the default** with an asterisk (*):
   ```
   Commands:
     edit*  Copyedit text using AI.
     self   Manage the copyedit_ai command.
   ```

### Testing Results

All tests pass (15/15) and code quality checks pass!

### Files Modified

1. `pyproject.toml` - Added llm dependency
2. `src/copyedit_ai/copyedit.py` - Created core copyediting module
3. `src/copyedit_ai/__main__.py` - Added edit command and default command support
4. `src/copyedit_ai/settings.py` - Added default_model setting
5. `tests/test_copyedit.py` - Created comprehensive tests for core module
6. `tests/test_cli.py` - Updated with tests for edit command
